## Upstream merge plan: integrate `chatwoot/chatwoot-mobile-app` develop into our branch (v4.1.0)

This document defines the exact strategy, commands, conflict policies, validations, and rollback steps to merge upstream changes from `chatwoot/chatwoot-mobile-app` `develop` into our working branch. Upstream reference: [chatwoot/chatwoot-mobile-app](https://github.com/chatwoot/chatwoot-mobile-app).

### Scope and decisions
- **Source**: upstream `chatwoot/chatwoot-mobile-app` → branch `develop`.
- **Target**: a new branch created off our local `development` branch (already created).
- **Strategy**: Merge (not rebase) to preserve fork history.
- **Package manager**: `pnpm` for install and local usage.
- **Protected local customizations (keep-local unless critical upstream security fix)**:
  - `app.config.ts`
  - `eas.json`
  - `firebase.json`
  - `credentials/` (Android/iOS service files)
  - `ios/` and `android/` app identifiers, signing and scheme settings
  - Branding assets: `assets/` (icons, splash), and any white-label text
  - Sentry DSN / analytics keys
  - Theme system (light/dark) customizations under `src/theme/**`
  - AI feature entry points and logic (AI button and related code paths)
- **Always take from upstream** when the change is a critical security fix or required breaking platform migration.
- **Validation required**: EAS iOS/Android builds, Redux Persist migrations, Firebase/APNs notifications, deep/universal links, core flows, and the AI feature.

### Preparation checklist
1) Ensure a clean working tree:
```bash
git status
git stash push -u -m "pre-upstream-merge-v4.1.0" # if needed
```
2) Confirm node/yarn/pnpm/expo/eas tooling is installed and up to date:
```bash
node -v && pnpm -v && npx expo --version && npx eas-cli --version
```
3) Verify local `development` is up to date:
```bash
git switch development
git pull --ff-only
```

### Create or switch to integration branch
If not already on the integration branch created from `development`, create/switch now:
```bash
# example name; adjust if you already created a different branch
git switch -c merge/upstream-develop-v4.1.0
```

### Link upstream and fetch
```bash
git remote -v
# add if missing
git remote add upstream https://github.com/chatwoot/chatwoot-mobile-app.git
git fetch upstream develop --prune
```

### Merge upstream/develop into integration branch
```bash
git merge --no-ff upstream/develop
```

If there are conflicts, resolve following the policy below, then:
```bash
git add -A
git commit
```

### Conflict resolution policy
Prefer keep-local for protected files/customizations, unless upstream changes are critical for security or required platform updates. Examples:

- Keep-local (ours):
```bash
# Example: keep our version
git restore --ours app.config.ts eas.json firebase.json
git add app.config.ts eas.json firebase.json
```

- Take upstream (theirs) for platform/security-mandatory changes:
```bash
# Example: accept upstream changes
git restore --theirs package.json src/** ios/** android/**
git add package.json src ios android
```

- Mixed resolution: open files, apply targeted edits preserving AI and theme logic while incorporating upstream fixes. When unsure, prefer manual merge and targeted diffs.

Document all conflicts and final decisions in the table at the end of this document.

### Dependencies and native sync
After a successful merge:
```bash
pnpm install
pnpm run run:doctor         # expo doctor
pnpm run check:config       # expo-config check
```

For native sync, we rely on the existing scripts. For development runs these clean and re-generate native projects as needed:
```bash
# Android development run
pnpm run android:dev

# iOS development run
pnpm run ios:dev
```

If a full re-generation is required explicitly:
```bash
pnpm run generate        # expo prebuild --clean
# or a softer prebuild
pnpm run generate:soft
```

### Post-merge validation matrix
Run through these suites on both platforms.

1) Core health
- pnpm install succeeds without peer conflicts
- `pnpm run run:doctor` green
- `pnpm run check:config` green

2) Build/run
- Android: `pnpm run android:dev` boots on device/emulator
- iOS: `pnpm run ios:dev` boots on simulator/device

3) Theming
- Verify light/dark theme toggling and per-screen adherence
- Check component theming under `src/theme/**` (type safety, tokens, colors)

4) AI feature (must-pass)
- AI button visible and interactive where expected
- End-to-end flows execute correctly (network requests, UI updates)
- Error states, loading, and retry paths behave

5) Redux Persist migrations
- If upstream changed state shape, confirm migrations (version bumps, transforms)
- Test update path: install old app build → upgrade to merged build → verify state loads without crashes and key data persists
- Test clean install path: delete app → install → initial boot works

6) Notifications (Firebase/APNs)
- Android FCM token retrieval and push receipt
- iOS APNs/FCM token retrieval and push receipt
- Foreground/background handling, navigation deep-links from notifications
- Verify `credentials/` and `firebase.json` remained correct

7) Deep linking / universal links
- Validate app opens to correct routes via links
- Confirm `app.config.ts` scheme/associations remained intact

8) Platform checks
- iOS signing and bundle identifiers unchanged
- Android applicationId, manifest permissions, and exported activities correct
- Sentry DSN and analytics keys intact

### EAS build validation
Run internal/dev builds first, then production profiles (adjust credentials as needed).

```bash
# Android internal/dev
pnpm run build:android:dev

# iOS internal/dev
pnpm run build:ios:dev

# Production builds (queued on EAS)
pnpm run build:android:prod
pnpm run build:ios:prod
```

After builds complete, install test artifacts and perform smoke/regression checks for the validation matrix above.

### Versioning notes
- After validating the merge, bump app versioning as required (e.g., `app.config.ts` APP_VERSION, and align with `eas.json` app version policy if necessary). Keep semantic versioning aligned to the doc name (v4.1.0) if this corresponds to our internal release tag.

### Rollback plan
- If the merge is in progress with conflicts: `git merge --abort`.
- If the merge was completed and committed: revert to pre-merge state via `git reset --hard ORIG_HEAD` (only if you have not made additional commits), or `git revert -m 1 <merge_commit_sha>` to create a revert commit.
- Keep the original `development` branch untouched; the integration happens on the dedicated merge branch.

### Troubleshooting and risks
- Expo/React Native version drifts: run `pnpm run run:doctor` and follow recommendations; consider `pnpm run generate` if native sync issues arise.
- iOS/Android native errors after merge: clear derived data / Gradle caches and rebuild using the provided scripts that regenerate native projects.
- TypeScript/ESLint breakages: fix incrementally; prefer typed, explicit fixes rather than `any`.
- Transitive dependency conflicts: prefer aligning to upstream `package.json` ranges unless they break local customizations; use `pnpm why` to diagnose.
- Push notifications failing: re-validate Firebase/APNs credentials, app identifiers, background modes, and notification handlers.

### Conflicts encountered (to be filled during merge)
| File/Path | Conflict summary | Decision (ours/theirs/manual) | Rationale |
|---|---|---|---|
|  |  |  |  |

### Audit log
- Upstream ref merged: `upstream/develop` @ <commit-sha-here>
- Local integration branch: `<your-branch-name>` off `development`
- Date: <yyyy-mm-dd>

### References
- Upstream repository: [chatwoot/chatwoot-mobile-app](https://github.com/chatwoot/chatwoot-mobile-app)


